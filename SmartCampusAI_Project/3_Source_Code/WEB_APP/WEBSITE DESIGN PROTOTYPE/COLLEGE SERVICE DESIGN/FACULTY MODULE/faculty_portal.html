<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusG Staff/Faculty Portal</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons (Used for the SVG icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom font and base styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        /* Define CampusG Colors */
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-dark: #4338ca; /* Indigo 700 */
            --secondary-color: #10b981; /* Emerald 500 */
            --accent-color: #f59e0b; /* Yellow 600 */
            --text-color: #1f2937; /* Gray 800 */
            --card-bg: #ffffff;
            --radius: 12px;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.06);
            font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background: #f1f5f9; /* Tailwind Slate 100 */
            display: flex;
            min-height: 100vh;
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 16px; /* Base font size */
        }
        
        /* --- Sidebar Styles --- */
        #sidebar {
            width: 256px; /* w-64 */
            background: #1f2937; /* Dark Gray for contrast */
            color: #fff;
            flex-shrink: 0;
            overflow-y: auto;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            padding-bottom: 30px;
            box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            z-index: 50; /* Ensure it stays above main content */
        }
        #sidebar .logo { padding: 18px 16px; display: flex; align-items: center; }
        .logo-title { font-weight: 800; font-size: 1.5rem; margin-left: 8px; }
        .logo-icon { width: 30px; height: 30px; color: var(--primary-color); }

        /* CONDENSED: Reduced vertical padding from 12px to 10px */
        .nav-item { display:flex; align-items:center; padding:10px 16px; color: rgba(255,255,255,0.8); text-decoration:none; transition: background 160ms, color 160ms; border-radius: 8px; margin: 0 10px; }
        .nav-item svg { width:20px;height:20px; margin-right:12px; flex-shrink:0; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-item.active { 
            background: var(--primary-color); 
            font-weight:700; 
            color: #fff;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
        }

        /* --- Main Content Layout --- */
        #main-content { 
            margin-left: 256px; /* w-64 for sidebar */
            flex:1; 
            padding:28px 32px; 
            max-width: 1600px; 
            width:calc(100% - 256px); 
            transition: margin-left 300ms ease;
        }

        header { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            background: var(--card-bg); 
            padding: 16px 24px; 
            border-radius: var(--radius);
            box-shadow: 0 6px 15px rgba(0,0,0,0.08); /* Stronger header shadow */
            margin-bottom:22px; 
        }
        .welcome h1 { margin:0; font-size:1.8rem; color:var(--primary-color); }
        .welcome p { margin:4px 0 0; color:#6b7280; font-size:0.9rem; } /* Gray 500 */

        /* --- Stats Cards --- */
        .stat-group { display:flex; gap:20px; margin:20px 0 30px; flex-wrap:wrap; }
        .stat-card { 
            display:flex; 
            flex-direction: column; 
            justify-content: space-between;
            padding:20px; 
            border-radius:var(--radius); 
            background:var(--card-bg); 
            box-shadow:0 6px 15px rgba(0,0,0,0.08); /* Softer initial shadow */
            border:1px solid #e5e7eb;
            flex: 1 1 200px; /* Responsive sizing */
            min-width:200px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1); /* Deeper shadow on hover */
        }
        .stat-content h4 { margin:0; font-size:0.9rem; color:#6b7280; font-weight: 500; }
        .stat-content p { margin:4px 0 0; font-size:1.8rem; font-weight:800; }
        .stat-icon-wrapper { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; margin-bottom: 10px; }
        
        /* Stat Color Schemes */
        .stat-primary .stat-icon-wrapper { background: #e0e7ff; }
        .stat-primary p { color: var(--primary-color); }
        .stat-secondary .stat-icon-wrapper { background: #d1fae5; }
        .stat-secondary p { color: var(--secondary-color); }
        .stat-accent .stat-icon-wrapper { background: #fffbeb; }
        .stat-accent p { color: var(--accent-color); }
        .stat-red .stat-icon-wrapper { background: #fee2e2; }
        .stat-red p { color: #dc2626; } /* Red 600 */


        /* --- Widget Grid --- */
        #widget-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:24px; align-items:start; }
        .widget-card { padding: 24px; border-radius: var(--radius); }
        .widget-header { margin-bottom: 16px; }
        .widget-header h3 { font-size: 1.25rem; font-weight: 700; color: var(--primary-color); }
        
        /* Task list styling */
        .task-list { list-style:none; padding:0; margin:0; }
        .task-item { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            padding:12px 0; 
            border-bottom:1px dashed #e5e7eb; 
            font-size: 0.95rem; 
            transition: background-color 0.1s ease; /* Added for schedule hover */
        }
        .task-item:last-child { border-bottom: none; padding-bottom: 0; }
        .task-item:hover:not(.schedule-item) {
             background-color: #f9fafb;
             border-radius: 4px;
             margin: 0 -12px;
             padding: 12px 12px;
             cursor: pointer;
        }

        .task-item button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; font-size: 0.85rem; transition: background-color 0.15s, transform 0.1s; }
        .btn-primary { background: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-neutral { background:#f3f4f6; color:#333; }
        .btn-neutral:hover { background:#e5e7eb; transform: translateY(-1px); }
        
        /* Schedule/Messaging styles */
        .schedule-item { border-left: 4px solid var(--primary-color); padding: 12px; border-radius: 6px; margin-bottom: 10px; background: #f9fafb; transition: background 0.15s; }
        .schedule-item:hover { background: #f5f7fa; } /* Schedule specific hover */
        .schedule-item-alt { border-left-color: var(--secondary-color); }
        .schedule-item-danger { border-left-color: #dc2626; }
        .message-summary { padding:10px 0; border-bottom:1px dashed #e5e7eb; }
        .message-summary:last-child { border-bottom: none; }
        .badge-urgent { color: #dc2626; font-weight: 700; background: #fee2e2; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; }
        
        /* --- Customization Panel Styles --- */
        #customization-panel { 
            position:fixed; 
            right:-380px; /* Reduced width */
            top: 84px; 
            width:340px; 
            background: #fff; 
            padding: 24px; 
            border-radius: var(--radius); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            transition:right 280ms ease; 
            z-index: 600; 
        }
        #customization-panel.open { right: 24px; }
        .widget-toggle-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #e5e7eb; }
        
        /* Toggle Switch CSS (Adapted for cleaner look) */
        .switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { background-color: #ccc; border-radius: 34px; transition: .4s; }
        .slider:before { height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(18px); }
        
        /* --- Mobile Adjustments --- */
        .mobile-menu-btn { display: none; }
        @media (max-width: 1023px) { /* Tailored for lg breakpoint */
            #sidebar { left: -256px; }
            #main-content { margin-left: 0; width: 100%; padding: 16px; }
            .mobile-menu-btn { display: inline-flex; }
            .stat-group { flex-direction: column; }
            .stat-card { min-width: 100%; }
        }
        @media (max-width: 768px) {
            header { flex-wrap: wrap; padding: 12px; }
            .welcome { width: 100%; margin-bottom: 10px; }
            #main-content { padding: 12px; }
        }
        /* Mobile sidebar open state */
        #sidebar.is-open { transform: translateX(0); }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'primary-dark': '#4338ca',
                        'secondary': '#10b981',
                        'accent': '#f59e0b',
                        'red-base': '#dc2626',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-gray-800">

    <!-- Sidebar / Navigation -->
    <nav id="sidebar" class="transition-transform duration-300">
        <div class="p-4 h-full flex flex-col">
            
            <!-- CONDENSED: Reduced padding bottom to pb-4 -->
            <div class="logo pb-4 border-b border-gray-700">
                <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3L1 9l11 6 11-6-11-6z"/>
                </svg>
                <span class="logo-title">CampusG Portal</span>
            </div>

            <!-- CONDENSED: Reduced mt-4 to mt-3 -->
            <div class="space-y-1 mt-3 flex-grow">
                <!-- CONDENSED: Reduced py-2 to py-1 -->
                <p class="text-xs font-semibold uppercase text-gray-500 pl-4 py-1">My Portal</p>
                <a class="nav-item active" href="#">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span>Dashboard</span>
                </a>
                
                <!-- CONDENSED: Reduced py-2 to py-1, pt-4 to pt-3 -->
                <p class="text-xs font-semibold uppercase text-gray-500 pl-4 py-1 pt-3 border-t border-gray-700">Modules</p>
                
                <!-- Full Set of Admin Links (Simplified for visibility) -->
                <a class="nav-item" href="dashboard.html">
                    <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                    <span>Executive Monitor</span>
                </a>
                <a class="nav-item" href="academics.html">
                    <i data-lucide="school" class="w-5 h-5"></i>
                    <span>Academics</span>
                </a>
                <a class="nav-item" href="finance.html">
                    <i data-lucide="banknote" class="w-5 h-5"></i>
                    <span>Finance</span>
                </a>
                <a class="nav-item" href="hr_staff.html">
                    <i data-lucide="briefcase-business" class="w-5 h-5"></i>
                    <span>HR & Staff</span>
                </a>
                <a class="nav-item" href="campus_life.html">
                    <i data-lucide="calendar-check" class="w-5 h-5"></i>
                    <span>Campus Life</span>
                </a>
                <a class="nav-item" href="tasks.html">
                    <i data-lucide="list-checks" class="w-5 h-5"></i>
                    <span>Tasks & Compliance</span>
                </a>
                <a class="nav-item" href="admissions.html">
                    <i data-lucide="graduation-cap" class="w-5 h-5"></i>
                    <span>Admissions</span>
                </a>
            </div>

            <!-- CONDENSED: Reduced mt-6 to mt-4 -->
            <button id="signout-button" class="w-full mt-4 flex items-center justify-center space-x-2 p-3 border border-gray-700 text-gray-300 rounded-lg hover:bg-red-700 hover:text-white transition duration-200">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Sign Out</span>
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div id="main-content">
        <header>
            <div class="welcome">
                <h1 class="text-2xl md:text-3xl font-extrabold">Welcome Back, <span class="text-gray-900">Dr. Johnson</span></h1>
                <p>Tuesday, October 5, 2025 | Current Semester: Fall 2025</p>
            </div>
            <button id="mobile-sidebar-toggle" class="mobile-menu-btn bg-primary text-white p-2 rounded-lg lg:hidden">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- 1. Alerts/Notifications -->
        <div id="notification-area" class="mb-6">
            <div class="notification-bar bg-yellow-50 p-3 rounded-lg border-l-4 border-accent shadow-md text-gray-700 flex justify-between items-start">
                <p class="text-sm md:text-base">
                    <strong class="font-bold text-accent">ACTION REQUIRED:</strong> 15 Grade Submissions are pending for CS 301. Deadline tomorrow.
                </p>
                <button class="close-btn p-1 text-gray-500 hover:text-gray-800" onclick="document.getElementById('notification-area').style.display='none';">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Overview Cards (Stats) -->
        <div class="stat-group">
            
            <div class="stat-card stat-primary">
                <div class="stat-icon-wrapper">
                    <i data-lucide="file-text" class="w-6 h-6 text-primary"></i>
                </div>
                <div class="stat-content">
                    <h4>Pending Grades</h4>
                    <p>4</p>
                </div>
            </div>

            <div class="stat-card stat-secondary">
                <div class="stat-icon-wrapper">
                    <i data-lucide="clock" class="w-6 h-6 text-secondary"></i>
                </div>
                <div class="stat-content">
                    <h4>Classes Today</h4>
                    <p>2 / 3</p>
                </div>
            </div>

            <div class="stat-card stat-accent">
                <div class="stat-icon-wrapper">
                    <i data-lucide="hourglass" class="w-6 h-6 text-accent"></i>
                </div>
                <div class="stat-content">
                    <h4>Avg. Grade Turnaround</h4>
                    <p>48h</p>
                </div>
            </div>
            
            <div class="stat-card stat-red">
                <div class="stat-icon-wrapper">
                    <i data-lucide="bell" class="w-6 h-6 text-red-base"></i>
                </div>
                <div class="stat-content">
                    <h4>Unread Messages</h4>
                    <p>2</p>
                </div>
            </div>
        </div>

        <!-- Widget Grid -->
        <div id="widget-grid">
            
            <!-- 2. Performance Analytics -->
            <div class="widget-card" id="widget-performance" data-name="Performance Analytics">
                <div class="widget-header">
                    <h3>Performance Analytics</h3>
                    <span class="text-sm text-gray-500">Last 30 Days</span>
                </div>
                <div class="widget-content">
                    <p class="text-lg font-semibold text-secondary mb-3">Overall Teaching Score: 4.6/5.0</p>
                    <div class="h-32 flex items-center justify-center text-gray-500 bg-gray-100 rounded-lg">
                        [Placeholder: Engagement & Grading Speed Chart]
                    </div>
                </div>
            </div>

            <!-- 3. My Schedule (Calendar/Appointments) -->
            <div class="widget-card" id="widget-schedule" data-name="My Schedule">
                <div class="widget-header">
                    <h3>Today's Schedule</h3>
                    <button class="text-primary hover:underline text-sm font-semibold">Full Calendar &rarr;</button>
                </div>
                <div class="widget-content">
                    <ul class="task-list">
                        <li class="task-item schedule-item border-primary" style="border-left-width: 4px;">
                            <span>CS 301 Lecture (Room 205)</span>
                            <span class="text-sm font-bold text-primary">10:00 AM</span>
                        </li>
                        <li class="task-item schedule-item border-accent" style="border-left-width: 4px;">
                            <span>Student Advising (Jane Doe)</span>
                            <span class="text-sm font-bold text-accent">1:30 PM</span>
                        </li>
                        <li class="task-item schedule-item border-red-base" style="border-left-width: 4px; border-bottom: none;">
                            <span>Faculty Meeting (Urgent)</span>
                            <span class="text-sm font-bold text-red-base">3:00 PM</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 4. Task Manager (To-do) -->
            <div class="widget-card" id="widget-tasks" data-name="Task Manager">
                <div class="widget-header">
                    <h3>My Pending Tasks</h3>
                    <span class="badge-urgent">4 Urgent</span>
                </div>
                <div class="widget-content">
                    <ul class="task-list">
                        <li class="task-item">
                            <span>Grade CS 301 Homework 2</span>
                            <button class="btn btn-neutral hover:bg-gray-200">Action</button>
                        </li>
                        <li class="task-item">
                            <span>Review Leave Request: Smith, J.</span>
                            <button class="btn btn-primary">Approve</button>
                        </li>
                        <li class="task-item">
                            <span>Update EE 405 Attendance (Mon)</span>
                            <button class="btn btn-neutral">Update</button>
                        </li>
                        <li class="task-item">
                            <span>Finalize Syllabus for Spring</span>
                            <button class="btn btn-neutral">Complete</button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 5. Communications Hub -->
            <div class="widget-card" id="widget-communications" data-name="Communications Hub">
                <div class="widget-header">
                    <h3>Inbox & Alerts</h3>
                    <button class="bg-secondary text-white py-1 px-3 rounded-lg text-sm font-semibold hover:bg-emerald-600">+ Message</button>
                </div>
                <div class="widget-content">
                    <div class="message-summary text-sm font-medium">
                        <strong>New Message:</strong> Student Advisor (Re: Jane's progress)
                    </div>
                    <div class="message-summary text-sm font-medium">
                        <strong>Announcement:</strong> System Update (Library access change)
                    </div>
                    <div class="message-summary text-sm font-medium border-b-0 pt-3">
                        <span class="text-primary font-bold">Inbox:</span> 2 Unread messages
                    </div>
                </div>
            </div>
            
            <!-- 6. Course Management Shortcuts -->
            <div class="widget-card" id="widget-courses" data-name="Course Shortcuts">
                <div class="widget-header">
                    <h3>My Courses</h3>
                    <span class="text-sm text-gray-500">3 Active</span>
                </div>
                <div class="widget-content">
                    <div class="p-3 bg-gray-50 rounded-lg mb-2 hover:bg-gray-100 transition">
                        <strong class="text-base">CS 301: Algorithms</strong>
                        <div class="text-xs text-gray-500 mt-1">
                            <a href="#" class="text-primary hover:underline">Materials</a> |
                            <a href="#" class="text-primary hover:underline">Assignments</a> |
                            <a href="#" class="text-primary hover:underline">Analytics</a>
                        </div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <strong class="text-base">EE 405: Circuits</strong>
                        <div class="text-xs text-gray-500 mt-1">
                            <a href="#" class="text-primary hover:underline">Materials</a> |
                            <a href="#" class="text-primary hover:underline">Assignments</a> |
                            <a href="#" class="text-primary hover:underline">Analytics</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 7. Leave & Attendance -->
            <div class="widget-card" id="widget-leave" data-name="Leave & Attendance">
                <div class="widget-header">
                    <h3>Leave & Attendance</h3>
                    <a href="#" class="text-accent font-semibold text-sm hover:underline">Request Leave</a>
                </div>
                <div class="widget-content">
                    <p class="text-lg font-bold mb-2">Remaining Leave: <span class="text-secondary">12 Days</span></p>
                    <p class="text-sm text-red-500 mb-4">Pending Approval: 1 Request</p>
                    <div class="pt-3 border-t border-gray-100">
                        <p class="font-semibold text-sm mb-1">Weekly Attendance:</p>
                        <p class="text-sm text-gray-600">Classes Covered: 10/10 (100%)</p>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Floating Customization Button -->
        <button id="customize-btn" class="fixed bottom-6 right-6 bg-primary text-white p-3 rounded-full shadow-lg hover:bg-primary-dark transition duration-300 z-50" onclick="toggleCustomizationPanel()" aria-label="Customize dashboard">
            <i data-lucide="settings-2" class="w-6 h-6"></i>
        </button>
    </div>
    
    <!-- Customization Panel -->
    <div id="customization-panel" class="shadow-2xl">
        <div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-4">
            <h3 class="text-xl font-bold text-gray-900">Customize Portal</h3>
            <button class="text-gray-600 hover:text-red-500 transition" onclick="toggleCustomizationPanel()">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        
        <p class="text-sm text-gray-600 mb-4">Toggle visibility of your dashboard widgets and quick actions.</p>

        <div id="widget-toggle-list" class="space-y-2">
            <!-- Widget toggles will be inserted here by JavaScript -->
        </div>
        
        <div class="mt-6 pt-4 border-t border-gray-100">
             <button onclick="restoreDefaultWidgets()" class="w-full bg-gray-100 text-gray-700 py-2 rounded-lg text-sm hover:bg-gray-200 transition">
                Restore Default Widgets
            </button>
        </div>
    </div>

    <!-- Pure JavaScript Logic -->
    <script>
        // Constants
        const MOCK_SESSION_KEY = 'campusg_session_mock';
        // Define all widget IDs once for easy reference and persistence
        const ALL_WIDGET_IDS = [
            'widget-performance', 'widget-schedule', 'widget-tasks', 'widget-communications', 
            'widget-courses', 'widget-leave'
        ];
        
        // Define containers
        const widgetGrid = document.getElementById('widget-grid');
        const sidebar = document.getElementById('sidebar');
        const customizationPanel = document.getElementById('customization-panel');
        const widgetToggleList = document.getElementById('widget-toggle-list');
        
        // Initial Widget State (Simulated Personalization)
        let widgetStates = [
            { id: 'widget-performance', visible: true, name: 'Performance Analytics' },
            { id: 'widget-schedule', visible: true, name: 'Today\'s Schedule' },
            { id: 'widget-tasks', visible: true, name: 'Pending Tasks' },
            { id: 'widget-communications', visible: true, name: 'Inbox & Alerts' },
            { id: 'widget-courses', visible: true, name: 'My Courses' },
            { id: 'widget-leave', visible: true, name: 'Leave & Attendance' },
        ];
        
        // --- Core UI & Logic Functions ---
        
        function renderWidgets() {
            // Get all widgets currently in the DOM
            const allWidgetsInDOM = document.querySelectorAll('.widget-card[id^="widget-"]');

            // 1. Detach all widgets from the DOM flow for reordering/hiding
            allWidgetsInDOM.forEach(widget => {
                if (widget.parentNode) {
                    widget.parentNode.removeChild(widget);
                }
            });

            // 2. Append visible widgets to the grid
            widgetStates.forEach(state => {
                const element = document.getElementById(state.id);
                if (element) {
                    if (state.visible) {
                        // Apply the correct grid-span class based on ID (optional, but shows flexibility)
                        const isWideWidget = state.id === 'widget-performance'; 
                        element.className = `widget-card bg-white p-6 rounded-xl shadow-lg ${isWideWidget ? 'lg:col-span-2' : ''}`;
                        widgetGrid.appendChild(element);
                    }
                } else {
                    console.warn(`Element with ID ${state.id} not found during rendering.`);
                }
            });

            // 3. Save state to mock storage
            localStorage.setItem('staffDashboardWidgets', JSON.stringify(widgetStates));
        }

        function initWidgetToggles() {
            widgetToggleList.innerHTML = '';
            widgetStates.forEach(state => {
                const item = document.createElement('div');
                item.className = 'widget-toggle-item';
                item.innerHTML = `
                    <span>${state.name}</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-${state.id}" ${state.visible ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                `;
                widgetToggleList.appendChild(item);

                document.getElementById(`toggle-${state.id}`).addEventListener('change', (e) => {
                    const index = widgetStates.findIndex(s => s.id === state.id);
                    if (index !== -1) {
                        widgetStates[index].visible = e.target.checked;
                        renderWidgets();
                    }
                });
            });
        }
        
        function restoreDefaultWidgets() {
            // Reset to default visibility state
            widgetStates = widgetStates.map(state => ({ ...state, visible: true }));
            
            // Re-render
            initWidgetToggles(); 
            renderWidgets(); 
            
            // Re-create icons to ensure they render after being moved
            lucide.createIcons();
            
            alert('Dashboard layout restored to default settings.');
        }

        function toggleCustomizationPanel() {
            customizationPanel.classList.toggle('open');
            if (customizationPanel.classList.contains('open')) {
                initWidgetToggles();
            }
        }
        
        // --- Setup and Initialization ---
        
        function setupSidebarToggle() {
            const toggleButton = document.getElementById('mobile-sidebar-toggle');
            const mainContent = document.getElementById('main-content');

            if (!sidebar || !toggleButton) return;

            toggleButton.addEventListener('click', () => {
                sidebar.classList.toggle('is-open');
            });
            
            mainContent.addEventListener('click', (event) => {
                const isSidebarOpen = sidebar.classList.contains('is-open');
                const isClickInsideSidebar = sidebar.contains(event.target);
                const isClickOnToggle = toggleButton.contains(event.target);
                
                // Close sidebar on outside click on mobile
                if (isSidebarOpen && !isClickInsideSidebar && !isClickOnToggle && window.innerWidth < 1024) { 
                    sidebar.classList.remove('is-open');
                }
            });
        }
        
        // --- Mock Session Functions (For sign out and testing) ---
        function clearMockSession() {
            localStorage.removeItem(MOCK_SESSION_KEY);
            localStorage.removeItem('staffDashboardWidgets');
            alert('Signed out successfully! Redirecting to login page...');
            window.location.href = 'login.html'; // Mock redirect
        }

        function setupSignoutButtons() {
            const signoutHandler = (event) => {
                event.preventDefault();
                clearMockSession();
            };
            const signoutButton = document.getElementById('signout-button');
            
            if (signoutButton) signoutButton.addEventListener('click', signoutHandler);
        }
        
        // --- Final Execution ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Load persisted state
            const persistedState = localStorage.getItem('staffDashboardWidgets');
            if (persistedState) {
                // Parse the persisted state and map it back to the active list
                const loadedStates = JSON.parse(persistedState);
                widgetStates = widgetStates.map(defaultState => {
                    const loadedState = loadedStates.find(s => s.id === defaultState.id);
                    return loadedState ? loadedState : defaultState;
                });
            }
            
            // 2. Initialize necessary scripts
            lucide.createIcons();
            setupSidebarToggle();
            setupSignoutButtons();
            
            // 3. Render widgets based on current state
            renderWidgets(); 
        });
    </script>
</body>
</html>
